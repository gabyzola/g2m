<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Quiz – MackAdapt</title>
    <link rel="stylesheet" href="style.css"/>
    <style>
      .card{max-width:720px;margin:8vh auto;background:#fff;padding:2rem;border-radius:10px;box-shadow:0 2px 12px rgba(0,40,85,.1)}
      .choices label{display:block;margin:.6rem 0;padding:.6rem;border:1px solid #ddd;border-radius:6px;cursor:pointer}
      .choices input{margin-right:.4rem}
      .actions{display:flex;gap:.75rem;margin-top:1rem}
      #resultModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);align-items:center;justify-content:center;z-index: 9999;}
      #resultModal .inner{background:#fff;padding:1.25rem;border-radius:10px;width:min(520px,92%)}
    </style>
  </head>
  <body>
    <header>
    <h1>MackAdapt</h1>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="classes.html">Classes</a></li>
        <li><a href="student-dashboard.html" class="active" aria-current="page">Student Dashboard</a></li>
        <li><a href="login.html">Login</a></li>
      </ul>
    </nav>
  </header>

    <main>
      <div class="card" id="objective-card" style="display:none;">
        <h2>Choose an Objective to Focus On</h2>
        <div id="objective-list"></div>

        <button id="objectiveSubmitBtn" style="margin-top:1rem;">
          Begin Quiz
        </button>
      </div>  

      <div class="card">
        <h2 id="q-stem">Loading question…</h2>
        <div class="choices" id="choices"></div>
        <div class="actions">
          <button id="nextBtn">Submit & Next</button>
        </div>
      </div>
    </main>

    <div id="resultModal"><div class="inner">
      <h3>Quiz Complete</h3>
      <p id="scoreLine"></p>
      <p class="small-text" id="focusLine"></p>
      <div style="display:flex;gap:.5rem">
        <button onclick="location.href='student-dashboard.html'">Return to Dashboard</button>
        <button onclick="location.href='classroom.html'">Back to Class</button>
      </div>
    </div></div>

    <footer><p>&copy; 2025 MackAdapt – Built for Merrimack College</p></footer>

    <script type="module">
      import { getStudentQuestions, getQuizObjectives, selectObjectiveForQuiz } from "./src/api/backend.js";

      const params = new URLSearchParams(window.location.search);
      const classId = params.get("classId");
      const quizId = params.get("quizId");
      const studentId = params.get("userId");


      const objectiveCard = document.getElementById("objective-card");
      const questionCard = document.querySelector(".card"); 
      const objectiveList = document.getElementById("objective-list");
      const submitObjectiveBtn = document.getElementById("objectiveSubmitBtn");

      questionCard.style.display = "none"; 


      const qStem = document.getElementById('q-stem');
      const choices = document.getElementById('choices');
      const nextBtn = document.getElementById('nextBtn');
      const resultModal = document.getElementById('resultModal');
      const scoreLine = document.getElementById('scoreLine');

      let QUESTIONS = [];
      let index = 0;
      let score = 0;

      let userAnswers = {};

      async function loadObjectives() { //tested: good
        const objectives = await getQuizObjectives(quizId);

        if (!objectives || objectives.length === 0) {
          objectiveCard.style.display = "none";
          questionCard.style.display = "block";
          loadQuestions();
          return;
        }

        objectiveList.innerHTML = objectives.map(obj => `
          <label style="display:block; margin:.6rem 0;">
            <input type="radio" name="objective" value="${obj.objectiveId}">
            ${obj.objectiveName}
          </label>
        `).join("");

        objectiveCard.style.display = "block";
      }

      //student selects objective- all good
      submitObjectiveBtn.addEventListener("click", async () => {
        const selected = document.querySelector("input[name='objective']:checked");

        if (!selected) {
          alert("Please select an objective.");
          return;
        }

        const objectiveId = selected.value;

        const result = await selectObjectiveForQuiz(quizId, studentId, objectiveId);

        if (result.status !== "success") {
          alert("Failed to select objective.");
          return;
        }
        objectiveCard.style.display = "none";
        questionCard.style.display = "block";

        loadQuestions();
      });


      //fixed, this is good: just need to store attempt in db so instructor can get results
      async function loadQuestions() {
        const raw = await getStudentQuestions(studentId, quizId);

        if (!raw || raw.length === 0) {
          qStem.textContent = "No questions available.";
          nextBtn.style.display = "none";
          return;
        }

        QUESTIONS = raw.map(q => {
          const choicesMap = {};
          q.choices.forEach(c => {
            choicesMap[c.choiceLabel] = c.choiceText;
          });
          const correctChoice = q.choices.find(c => c.choiceId === q.correctChoiceId);
          const correctLabel = correctChoice ? correctChoice.choiceLabel : null;

          return {
            questionId: q.questionId,
            questionText: q.questionText,
            difficulty: q.difficulty,
            learningObjective: q.learningObjective,
            choices: choicesMap,
            correctChoiceId: q.correctChoiceId,
            correctAnswer: correctLabel
          };
        });

        index = 0;
        render();
      }

      function render() {

        const q = QUESTIONS[index];

        qStem.textContent = q.questionText;

        const opts = ["A", "B", "C", "D"];

        choices.innerHTML = opts.map(letter => `
          <label>
            <input type="radio" name="ans" value="${letter}">
            ${q.choices[letter]}
          </label>
        `).join("");

        nextBtn.textContent =
          index < QUESTIONS.length - 1
          ? "Submit & Next"
          : "Submit & Finish";
      }


      nextBtn.addEventListener("click", () => {
        const selected = document.querySelector('input[name="ans"]:checked');
        if (!selected) {
          alert("Choose an answer");
          return;
        }

        const chosenLetter = selected.value;
        const q = QUESTIONS[index];
        const correctLetter = q.correctAnswer;

        const allLabels = document.querySelectorAll("#choices label");
        allLabels.forEach(label => label.style.backgroundColor = ""); 

        const chosenLabel = [...allLabels].find(l => l.querySelector('input').value === chosenLetter);
        if (chosenLetter === correctLetter) {
          chosenLabel.style.backgroundColor = "#d4edda"; 
        } else {
          chosenLabel.style.backgroundColor = "#f8d7da"; 
          const correctLabelEl = [...allLabels].find(l => l.querySelector('input').value === correctLetter);
          if (correctLabelEl) correctLabelEl.style.backgroundColor = "#d4edda"; 
        }

        userAnswers[q.questionId] = chosenLetter;

        setTimeout(() => {
          index++;
          if (index >= QUESTIONS.length) {
            finishQuiz();
          } else {
            render();
          }
        }, 1000); 
      });


      function finishQuiz() {
        const pct = Math.round((score / QUESTIONS.length) * 100);
        scoreLine.textContent = `You scored ${pct}%.`;
        resultModal.style.display = "flex";
      }


      loadObjectives();
    </script>

  </body>
</html>