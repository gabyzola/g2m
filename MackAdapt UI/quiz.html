<!-- To Dos -->
<!-- 
Display quiz questions one by one

-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Quiz – MackAdapt</title>
    <link rel="stylesheet" href="style.css"/>
    <style>
      .card{max-width:720px;margin:8vh auto;background:#fff;padding:2rem;border-radius:10px;box-shadow:0 2px 12px rgba(0,40,85,.1)}
      .choices label{display:block;margin:.6rem 0;padding:.6rem;border:1px solid #ddd;border-radius:6px;cursor:pointer}
      .choices input{margin-right:.4rem}
      .actions{display:flex;gap:.75rem;margin-top:1rem}
      #resultModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);align-items:center;justify-content:center;z-index: 9999;}
      #resultModal .inner{background:#fff;padding:1.25rem;border-radius:10px;width:min(520px,92%)}
    </style>
  </head>
  <body>
    <header>
    <h1>MackAdapt</h1>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="classes.html">Classes</a></li>
        <li><a href="student-dashboard.html" class="active" aria-current="page">Student Dashboard</a></li>
        <li><a href="login.html">Login</a></li>
      </ul>
    </nav>
  </header>

    <main>
      <div class="card">
        <h2 id="q-stem">Loading question…</h2>
        <div class="choices" id="choices"></div>
        <div class="actions">
          <button id="nextBtn">Submit & Next</button>
        </div>
      </div>
    </main>

    <div id="resultModal"><div class="inner">
      <h3>Quiz Complete</h3>
      <p id="scoreLine"></p>
      <p class="small-text" id="focusLine"></p>
      <div style="display:flex;gap:.5rem">
        <button onclick="location.href='student-dashboard.html'">Return to Dashboard</button>
        <button onclick="location.href='classroom.html'">Back to Class</button>
      </div>
    </div></div>

    <footer><p>&copy; 2025 MackAdapt – Built for Merrimack College</p></footer>

    <script type="module">
      import { getQuizQuestions } from "./src/api/backend.js";

      const params = new URLSearchParams(window.location.search);
      const classId = params.get("classId");
      const quizId = params.get("quizId");

      const STUDENT_ID = 7;

      const qStem = document.getElementById('q-stem');
      const choices = document.getElementById('choices');
      const nextBtn = document.getElementById('nextBtn');
      const resultModal = document.getElementById('resultModal');
      const scoreLine = document.getElementById('scoreLine');

      let QUESTIONS = [];
      let index = 0;
      let score = 0;

      let userAnswers = {}; 


      async function loadQuestions() {
        const raw = await getQuizQuestions(quizId);

        if (!raw || raw.length === 0) {
          qStem.textContent = "No questions available.";
          nextBtn.style.display = "none";
          return;
        }

        const grouped = {};
        raw.forEach(row => {
          const qid = row.questionId;

          if (!grouped[qid]) {
            grouped[qid] = {
              questionId: qid,
              questionText: row.questionText,
              difficulty: row.difficulty,
              learningObjective: row.learningObjective,
              choices: {},   
              correctChoiceId: row.correctChoiceId
            };
          }

          grouped[qid].choices[row.choiceLabel] = row.choiceText;
        });

        QUESTIONS = Object.values(grouped);

        QUESTIONS.forEach(q => {
          const match = raw.find(r => r.choiceId === q.correctChoiceId);
          q.correctAnswer = match ? match.choiceLabel : null;
        });

        index = 0;
        render();
      }

      function render() {

        const q = QUESTIONS[index];

        qStem.textContent = q.questionText;

        const opts = ["A", "B", "C", "D"];

        choices.innerHTML = opts.map(letter => `
          <label>
            <input type="radio" name="ans" value="${letter}">
            ${q.choices[letter]}
          </label>
        `).join("");

        nextBtn.textContent =
          index < QUESTIONS.length - 1
          ? "Submit & Next"
          : "Submit & Finish";
      }


      nextBtn.addEventListener("click", () => {
        const selected = document.querySelector('input[name="ans"]:checked');
        if (!selected) {
          alert("Choose an answer");
          return;
        }

        const chosenLetter = selected.value;
        const correctLetter = QUESTIONS[index].correctAnswer;

        userAnswers[QUESTIONS[index].questionId] = chosenLetter;

        if (chosenLetter === correctLetter) {
          score++;
        }

        index++;

        if (index >= QUESTIONS.length) {
          finishQuiz();
        } else {
          render();
        }
      });

      function finishQuiz() {
        const pct = Math.round((score / QUESTIONS.length) * 100);
        scoreLine.textContent = `You scored ${pct}%.`;
        resultModal.style.display = "flex";
      }


      loadQuestions();
    </script>

  </body>
</html>