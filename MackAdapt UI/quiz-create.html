<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Create Quiz – MackAdapt</title>
    <link rel="stylesheet" href="style.css"/>
    <style>
      .panel{background:#fff;padding:1.25rem;border-radius:10px;box-shadow:0 2px 10px rgba(0,40,85,.08);margin:1rem 0}
      .row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
      label{display:block;margin:.5rem 0 .25rem}
      input,select,textarea{width:100%;padding:.65rem;border:1px solid #ccc;border-radius:6px}
      textarea{min-height:110px}
      .actions{display:flex;gap:.75rem;margin-top:1rem}
      .notice{font-size:.9rem;color:#444;margin-top:.5rem}
    </style>
  </head>
  <body>
    <header>
    <h1>MackAdapt</h1>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="classes.html" class="active" aria-current="page">Classes</a></li>
        <li><a href="student-dashboard.html">Student Dashboard</a></li>
        <li><a href="login.html">Login</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <h2>Create Quiz</h2>
    <div style="margin:.25rem 0 1rem">
      <strong>Quick Links:</strong>
      <a href="classes.html">Back to Classes</a>
    </div>

    <div class="panel">
      <h3>Quiz Details</h3>

      <label>Quiz Name</label>
      <input id="quizName" type="text" placeholder="Enter quiz name..." />
    </div>


    <div class="panel">
      <h3>Link a Reading</h3>

      <label>Select Reading</label>
      <select id="readingSelect">
        
      </select>

      <div class="actions">
        <button id="addReadingBtn">Attach Reading</button>
      </div>
    </div>

    <div class="panel">
      <h3>Questions</h3>

      <!-- <label>Learning Objective</label> -->
      <select id="objective" style="display:none;"></select>

      <div id="questionContainer"></div>

      <div class="actions">
        <button id="newQuestionBtn">Add Question</button>
        <button id="saveQuizBtn">Save Quiz</button>
      </div>

      <p class="notice">Add as many questions as you need.</p>
    </div>

  </main>

  <footer><p>&copy; 2025 MackAdapt – Built for Merrimack College</p></footer>
  <script type="module">
      import { createQuiz, addQuestion, addReadingToQuiz } from "./src/api/backend.js";


    const query = new URLSearchParams(window.location.search);
    const quizId = query.get("quizId");
    const classId = query.get("classId");
    const userId = query.get("userId");

    const readingSelect = document.getElementById("readingSelect");
    const objectiveSelect = document.querySelector("#objective");

    let questionIndex = 0;

    function createQuestionBlock() {
      const block = document.createElement("div");
      block.classList.add("panel");
      block.style.border = "1px solid #ccc";
      block.style.padding = "1rem";
      block.style.marginBottom = "1rem";

      const idx = questionIndex++;

      block.innerHTML = `
          <h4>Question ${idx + 1}</h4>

          <label>Question Text</label>
          <textarea class="q-text"></textarea>

          <label>Difficulty</label>
          <select class="q-difficulty">
            <option>Easy</option>
            <option>Medium</option>
            <option>Hard</option>
          </select>

          <label>Learning Objective</label>
          <select class="q-objective">
            ${objectiveSelect.innerHTML}
          </select>

          <label>A)</label>
          <input class="q-A">

          <label>B)</label>
          <input class="q-B">

          <label>C)</label>
          <input class="q-C">

          <label>D)</label>
          <input class="q-D">

          <label>Correct Answer (A/B/C/D)</label>
          <input class="q-correct" maxlength="1" placeholder="A/B/C/D">
      `;

      return block;
    }

    document.getElementById("newQuestionBtn").addEventListener("click", () => {
      document.getElementById("questionContainer").appendChild(createQuestionBlock());
    });

   
    async function loadReadings() {
      
      try {
        const res = await fetch(`/api/classes/${classId}/readings`);
        if (!res.ok) throw new Error("Failed to fetch readings");

        const data = await res.json();
        readingSelect.innerHTML = "";

        if (!data || data.length === 0) {
          const op = document.createElement("option");
          op.textContent = "No readings available";
          op.disabled = true;
          op.selected = true;
          readingSelect.appendChild(op);
          return;
        }

        data.forEach(reading => {
          const op = document.createElement("option");
          op.value = reading.readingId;
          op.textContent = reading.readingName;
          readingSelect.appendChild(op);
        });

        loadObjectives(data[0].readingId);

      } catch (err) {
        console.error("Failed to load readings:", err);
        readingSelect.innerHTML = "<option disabled selected>Error loading readings</option>";
      }
    }

    loadReadings();

    async function loadObjectives(readingId) {
      try {
        const res = await fetch(`/api/quizzes/${readingId}/readingobjectives`);
        if (!res.ok) throw new Error("Failed to fetch objectives");

        const data = await res.json();
        objectiveSelect.innerHTML = "";

        if (!data || data.length === 0) {
          const op = document.createElement("option");
          op.textContent = "No objectives available";
          op.disabled = true;
          op.selected = true;
          objectiveSelect.appendChild(op);
          return;
        }

        data.forEach(obj => {
          const op = document.createElement("option");
          op.value = obj.objectiveId; 
          op.textContent = obj.objectiveName;
          objectiveSelect.appendChild(op);
        });

        if (questionIndex === 0) {
          document.getElementById("questionContainer").appendChild(createQuestionBlock());
        }


      } catch (err) {
        console.error("Failed to load objectives:", err);
        objectiveSelect.innerHTML = "<option disabled selected>Error loading objectives</option>";
      }
    }

    readingSelect.addEventListener("change", () => {
      const selectedReadingId = parseInt(readingSelect.value);
      if (selectedReadingId) loadObjectives(selectedReadingId);
    });

  
    document.getElementById("addReadingBtn").addEventListener("click", async () => {
    const readingId = parseInt(readingSelect.value);

    if (!readingId) {
      alert("Please select a reading first.");
      return;
    }
    console.log("Linking reading:", { quizId, readingId });

    const result = await addReadingToQuiz(quizId, readingId);
    console.log(result);

    if (result && result.success) {
      alert("Reading linked to quiz!");
    } else {
      console.error("Error linking reading:", result);
      alert("Failed to link reading.");
    }
  });

    document.getElementById("saveQuizBtn").addEventListener("click", async () => {
      const quizName = document.getElementById("quizName").value.trim();
      if (!quizName) return alert("Please enter a quiz name!");
      if (!quizId) return alert("Quiz ID not found in URL.");

      const nameRes = await fetch(`/api/quizzes/${quizId}/name`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ quizName })
    });

    const nameResult = await nameRes.json();
    if (!nameRes.ok || nameResult.status !== "success") {
      alert("Failed to update quiz name.");
      return;
    }

      const blocks = document.querySelectorAll("#questionContainer .panel");

      for (const block of blocks) {
        const questionData = {
          questionText: block.querySelector(".q-text").value.trim(),
          difficulty: block.querySelector(".q-difficulty").value,
          choiceA: block.querySelector(".q-A").value.trim(),
          choiceB: block.querySelector(".q-B").value.trim(),
          choiceC: block.querySelector(".q-C").value.trim(),
          choiceD: block.querySelector(".q-D").value.trim(),
          correctAnswer: block.querySelector(".q-correct").value.trim().toUpperCase(),
          objectiveId: parseInt(block.querySelector(".q-objective").value)
        };

        const result = await addQuestion(quizId, questionData);
        if (!result || result.status !== "success") {
          alert("A question failed to save.");
          return;
        }
      }

      alert("Quiz saved successfully!");
      window.location.href = `class-module.html?classId=${classId}&userId=${userId}`;
    });
  </script>
  </body>
</html>